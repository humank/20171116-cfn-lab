Description: >

    This template deploys a well-architected web application architecture, which contains a VPC, with a pair of public and private subnets spread 
    across two Availabilty Zones. It deploys an Internet Gateway, with a default 
    route on the public subnets. It deploys a pair of NAT Gateways (one in each AZ), 
    and default routes for them in the private subnets.
    
    And also deploy a RDS in multiple-AZ, and Application server via elasticbeanstalk
    (if time is enough, then i will take more on elasticbeanstalk)

    Last Modified: 22 October 2017
    Author: Kim Kao <yikaikao@amazon.com>

Resources:

  VPC:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:<< File URI which you upload to s3 bucket>>/vpc.cfn.yml
      Parameters:
        SSHFrom:
          Description: Limit SSH access to bastion hosts to a CIDR IP block
          Type: String
          MinLength: 9
          MaxLength: 18
          Default: 0.0.0.0/0

        ELBIngressPort:
          Description: The ELB ingress port used by security groups
          Type: Number
          MinValue: 0
          MaxValue: 65535
          ConstraintDescription: TCP ports must be between 0 - 65535
          Default: 80

        AppIngressPort:
          Description: The application ingress port used by security groups
          Type: Number
          MinValue: 0
          MaxValue: 65535
          ConstraintDescription: TCP ports must be between 0 - 65535
          Default: 80

        SingleNatGateway:
          Description: Set to true to only install one NAT gateay
          Type: String
          ConstraintDescription: Value must be true or false
          Default: true
          AllowedValues:
            - true
            - false
  
  BASTION:
    Type: AWS::CloudFormation::Stack
    Properties:
            TemplateURL: TemplateURL:<< File URI which you upload to s3 bucket>>/bastion.cfn.yml
            Parameters:
                EnvironmentName:    !Ref AWS::StackName
                NetworkStackName:
                  Description: Active CloudFormation stack containing VPC resources.
                  Type: String
                  MinLength: 1
                  MaxLength: 255
                  AllowedPattern: "^[a-zA-Z][-a-zA-Z0-9]*$"

                KeyName:
                  Description: EC2 key pair name for bastion host SSH access
                  Type: String
                  MinLength: 1
                  MaxLength: 255
                  AllowedPattern: "[\\x20-\\x7E]*"
                  ConstraintDescription: Key pair name can contain only ASCII characters.

  DB:
    Type: AWS::CloudFormation::Stack
    Properties:
            TemplateURL: TemplateURL:<< File URI which you upload to s3 bucket>>/db.cfn.yml
            Parameters:
              NetworkStackName:
                Description: Name of an active CloudFormation stack that contains networking resources.
                Type: String
                MinLength: 1
                MaxLength: 255
                AllowedPattern: "^[a-zA-Z][-a-zA-Z0-9]*$"

              DatabaseUser:
                Default: startupadmin
                NoEcho: 'true'
                Type: String
                Description: Database admin account name
                MinLength: 5
                MaxLength: 16
                AllowedPattern: "[a-zA-Z][a-zA-Z0-9]*"
                ConstraintDescription: Name must begin with a letter and contain only alphanumeric characters.

              DatabasePassword:
                Default: 0bee082a464
                NoEcho: 'true'
                Type: String
                Description: Database admin account password
                MinLength: 6
                MaxLength: 41
                AllowedPattern: "[a-zA-Z0-9]*"
                ConstraintDescription: Password must contain only alphanumeric characters.

              DatabaseName:
                Default: StartupDB
                Type: String
                Description: Database name
                MinLength: 1
                MaxLength: 30
                AllowedPattern: "[a-zA-Z][a-zA-Z0-9]*"
                ConstraintDescription: Name must begin with a letter and contain only alphanumeric characters.
                
              DatabaseSize:
                Default: 5
                Type: String
                Description: Database storage size in gigabytes (GB)
                MinLength: 1
                AllowedPattern: "[5-9]|[1-9][0-9]+"
                ConstraintDescription: Enter a size of at least 5 GB
                
              DatabaseEngine:
                Default: mysql
                Type: String
                Description: Database engine, MySQL or PostgreSQL
                ConstraintDescription: Choose an engine from the drop down
                AllowedValues: 
                  - mysql
                  - postgres
                
              DatabaseInstanceClass:
                Default: db.t2.micro
                Type: String
                Description: Database instance class, e.g. db.t2.micro (free tier)
                ConstraintDescription: Choose an instance class from the drop down
                AllowedValues: 
                  - db.t2.micro
                  - db.t2.small
                  - db.t2.medium
                  - db.t2.large
                  - db.m4.large
                  - db.m4.xlarge
                  - db.m4.2xlarge
                  - db.m4.4xlarge
                  - db.m4.10xlarge
                  - db.r3.large
                  - db.r3.xlarge
                  - db.r3.2xlarge
                  - db.r3.4xlarge
                  - db.r3.8xlarge
                  
              EnvironmentName:
                Description: Environment name, either dev or prod.
                Type: String
                MinLength: 1
                MaxLength: 255
                AllowedValues: 
                  - dev
                  - prod
                ConstraintDescription: Specify either dev or prod.

    
    

  Outputs:
    WebsiteServiceUrl: 
        Description: The URL endpoint for the website service
        Value: !Join ["", [ !GetAtt ALB.Outputs.LoadBalancerUrl, "/" ]]